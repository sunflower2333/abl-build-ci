From 1f8682149b14e63d78e93d9d36ff22ca8df1a933 Mon Sep 17 00:00:00 2001
From: KancyJoe <kancy2333@outlook.com>
Date: Wed, 3 Dec 2025 16:07:56 +0000
Subject: [PATCH 11/12] only allow rotate driver load from application

---
 .../Driver/GopFBRotate/GopFBRotate.c          | 92 +++++++++++++++++--
 1 file changed, 85 insertions(+), 7 deletions(-)

diff --git a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
index b1436ec8..251a6426 100644
--- a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
+++ b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
@@ -10,6 +10,7 @@
 #include <Library/DxeServicesTableLib.h>
 #include <Protocol/DevicePath.h>
 #include <Protocol/GraphicsOutput.h>
+#include <Protocol/LoadedImage.h>
 #include <Protocol/EFIKernelInterface.h>
 
 /// Defines
@@ -206,8 +207,7 @@ STATIC VOID RotateFramebufferNeon(
                         *(UINT32*)(colBaseB + 3*DstStride + fr2 * FB_BYTES_PER_PIXEL) = d23;
                         *(UINT32*)(colBaseB + 3*DstStride + fr3 * FB_BYTES_PER_PIXEL) = d33;
 
-                        // 底半部分 4 列
-                        UINT8 *colBaseBottom = colBase; // 同列索引，不同行翻转位置
+                        UINT8 *colBaseBottom = colBase;
                         UINT8 *colBaseBottomB = colBaseB;
                         __asm__ __volatile__(
                                 "ld1 {v0.4s}, [%[r4]]\n"
@@ -442,9 +442,9 @@ RotateFramebufferTask(
         }
         #endif
 
-        // 100ms ~= 10fps, memcpy also need time.
+        // 80ms ~= 12fps, memcpy also need time.
         // Cpu need to take a rest to not be hot.
-        ((EFI_KERNEL_PROTOCOL *)TaskParams->KernIntf)->Thread->ThreadSleep(100);
+        ((EFI_KERNEL_PROTOCOL *)TaskParams->KernIntf)->Thread->ThreadSleep(80);
     }
     while(1);
 
@@ -871,6 +871,74 @@ InstallExit:
   return Status;
 }
 
+// Check if driver is loaded from Application stage
+// Method: Check parent image's ImageCodeType
+STATIC
+BOOLEAN
+IsLoadedFromApplication(IN EFI_HANDLE ImageHandle)
+{
+    EFI_STATUS Status;
+    EFI_LOADED_IMAGE_PROTOCOL *LoadedImage = NULL;
+    EFI_LOADED_IMAGE_PROTOCOL *ParentImage = NULL;
+    BOOLEAN IsFromApp = FALSE;
+
+    Status = gBS->OpenProtocol(
+        ImageHandle,
+        &gEfiLoadedImageProtocolGuid,
+        (VOID **)&LoadedImage,
+        ImageHandle,
+        NULL,
+        EFI_OPEN_PROTOCOL_GET_PROTOCOL
+    );
+
+    if (EFI_ERROR(Status) || LoadedImage == NULL) {
+        return FALSE;
+    }
+
+    // If no parent, loaded from firmware
+    if (LoadedImage->ParentHandle == NULL) {
+        IsFromApp = FALSE;
+        goto Exit;
+    }
+
+    // Get parent's LoadedImage protocol
+    Status = gBS->OpenProtocol(
+        LoadedImage->ParentHandle,
+        &gEfiLoadedImageProtocolGuid,
+        (VOID **)&ParentImage,
+        ImageHandle,
+        NULL,
+        EFI_OPEN_PROTOCOL_GET_PROTOCOL
+    );
+
+    if (EFI_ERROR(Status) || ParentImage == NULL) {
+        IsFromApp = FALSE;
+        goto Exit;
+    }
+
+    // Check parent's ImageCodeType:
+    // EfiLoaderCode (1) = Application/Loader
+    // EfiBootServicesCode (3) = DXE driver/core
+    IsFromApp = (ParentImage->ImageCodeType == EfiLoaderCode);
+
+    gBS->CloseProtocol(
+        LoadedImage->ParentHandle,
+        &gEfiLoadedImageProtocolGuid,
+        ImageHandle,
+        NULL
+    );
+
+Exit:
+    gBS->CloseProtocol(
+        ImageHandle,
+        &gEfiLoadedImageProtocolGuid,
+        ImageHandle,
+        NULL
+    );
+
+    return IsFromApp;
+}
+
 EFI_STATUS
 EFIAPI
 GopFBRotateEntryPoint (
@@ -881,7 +949,10 @@ GopFBRotateEntryPoint (
     EFI_STATUS Status = EFI_SUCCESS;
     EFI_PHYSICAL_ADDRESS FakeFrameBufferAddr = 0;
 
-    DEBUG((DEBUG_INFO, "GopFBRotateEntryPoint: ImageHandle=%p, SystemTable=%p\n", ImageHandle, SystemTable));
+    // Only allow loading from Application stage
+    if (!IsLoadedFromApplication(ImageHandle)) {
+        return EFI_ACCESS_DENIED;
+    }
 
     Status = ScanGop();
     if (EFI_ERROR(Status)) {
@@ -901,10 +972,9 @@ GopFBRotateEntryPoint (
     }
 
     Status = SimpleFbDxeEntry(&FakeFrameBufferAddr);
-
     if (EFI_ERROR(Status)) {
         DEBUG((DEBUG_ERROR, "SimpleFbDxeEntry failed: %r\n", Status));
-        return Status;
+        goto ErrorExit;
     }
 
     Status = ScanGop();
@@ -916,7 +986,15 @@ GopFBRotateEntryPoint (
         FakeFrameBufferAddr,
         FixedPcdGet32(PcdMipiFrameBufferHardwareBase)
     );
+    if (EFI_ERROR(Status)) {
+        DEBUG((DEBUG_ERROR, "StartRotateTask failed: %r\n", Status));
+        goto ErrorExit;
+    }
 
     DEBUG((DEBUG_INFO, "GopFBRotate sequence complete\n"));
     return EFI_SUCCESS;
+
+ErrorExit:
+    DEBUG((DEBUG_ERROR, "GopFBRotateEntryPoint: Initialization failed with status %r\n", Status));
+    return Status;
 }
-- 
2.43.0


From 1a37715d0aa5fe7544fa8bab388ccab09e39eb02 Mon Sep 17 00:00:00 2001
From: KancyJoe <kancy2333@outlook.com>
Date: Sat, 6 Dec 2025 10:41:56 +0000
Subject: [PATCH 12/13] driver: goprotate: get FB addr and width/height from
 previous gop.

---
 .../Driver/GopFBRotate/GopFBRotate.c          | 94 ++++++++++++++++---
 .../Driver/GopFBRotate/GopFBRotate.inf        |  3 -
 QcomModulePkg/QcomModulePkg.dec               |  4 +-
 3 files changed, 83 insertions(+), 18 deletions(-)

diff --git a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
index 251a6426..151ea4ea 100644
--- a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
+++ b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.c
@@ -43,6 +43,8 @@ typedef struct {
   EFI_KERNEL_PROTOCOL *KernIntf;
   EFI_PHYSICAL_ADDRESS FakeFrameBufferAddr;
   EFI_PHYSICAL_ADDRESS HwFrameBufferAddr;
+  UINT32 Width;
+  UINT32 Height;
 } FrameBufferRotateTaskParams;
 
 STATIC FrameBufferRotateTaskParams gTaskParams = {0};
@@ -337,7 +339,9 @@ EFI_STATUS
 EFIAPI
 StartRotateTask(
   IN EFI_PHYSICAL_ADDRESS FakeFrameBufferAddr,
-  IN EFI_PHYSICAL_ADDRESS HwFrameBufferAddr
+  IN EFI_PHYSICAL_ADDRESS HwFrameBufferAddr,
+  IN UINT32 Width,
+  IN UINT32 Height
 ){
   EFI_STATUS Status = EFI_SUCCESS;
   Thread* FBRotateTD = NULL;
@@ -354,6 +358,8 @@ StartRotateTask(
   gTaskParams.KernIntf = KernIntf;
   gTaskParams.FakeFrameBufferAddr = FakeFrameBufferAddr;
   gTaskParams.HwFrameBufferAddr = HwFrameBufferAddr;
+  gTaskParams.Width = Width;
+  gTaskParams.Height = Height;
 
   FBRotateTD = KernIntf->Thread->ThreadCreate ("FrameBufferRotateThread",
       &RotateFramebufferTask, &gTaskParams, UEFI_THREAD_PRIORITY + 1,
@@ -410,8 +416,8 @@ RotateFramebufferTask(
         return -1;
     }
 
-    Horizontal    = FixedPcdGet32(PcdMipiFrameBufferWidth);
-    Vertical      = FixedPcdGet32(PcdMipiFrameBufferHeight);
+    Horizontal    = TaskParams->Width;
+    Vertical      = TaskParams->Height;
     BytesPerPixel = FB_BYTES_PER_PIXEL;
     SrcStride     = Horizontal * BytesPerPixel;
     DstStride     = Vertical * BytesPerPixel;
@@ -530,6 +536,51 @@ ScanGop(VOID)
     return EFI_SUCCESS;
 }
 
+// Get previous GOP's FrameBuffer address and resolution
+STATIC EFI_STATUS
+GetPrevGopInfo(
+    OUT UINTN *FBAddress,
+    OUT UINT32 *Vertical,
+    OUT UINT32 *Horizontal
+)
+{
+    EFI_STATUS Status;
+    EFI_HANDLE *HandleBuffer = NULL;
+    UINTN HandleCount = 0;
+    EFI_GRAPHICS_OUTPUT_PROTOCOL *Gop = NULL;
+
+    if (FBAddress == NULL || Vertical == NULL || Horizontal == NULL) {
+        return EFI_INVALID_PARAMETER;
+    }
+
+    Status = gBS->LocateHandleBuffer(ByProtocol, &gEfiGraphicsOutputProtocolGuid, NULL, &HandleCount, &HandleBuffer);
+    if (EFI_ERROR(Status) || HandleCount == 0) {
+        return EFI_NOT_FOUND;
+    }
+
+    // Get first GOP handle
+    Status = gBS->HandleProtocol(HandleBuffer[0], &gEfiGraphicsOutputProtocolGuid, (VOID **)&Gop);
+    if (EFI_ERROR(Status) || Gop == NULL || Gop->Mode == NULL || Gop->Mode->Info == NULL) {
+        if (HandleBuffer != NULL) {
+            gBS->FreePool(HandleBuffer);
+        }
+        return EFI_NOT_FOUND;
+    }
+
+    // Extract FrameBuffer address and resolution
+    *FBAddress = (UINTN)Gop->Mode->FrameBufferBase;
+    *Vertical = (UINT32)Gop->Mode->Info->VerticalResolution;
+    *Horizontal = (UINT32)Gop->Mode->Info->HorizontalResolution;
+
+    if (HandleBuffer != NULL) {
+        gBS->FreePool(HandleBuffer);
+    }
+
+    return EFI_SUCCESS;
+}
+
+
+
 /*
  * Bits per pixel selector. Each value n is such that the bits-per-pixel is
  * 2 ^ n
@@ -739,19 +790,20 @@ UninstallGop(VOID)
 EFI_STATUS
 EFIAPI
 SimpleFbDxeEntry(
-  OUT EFI_PHYSICAL_ADDRESS *MipiFrameBufferAddr
+  OUT EFI_PHYSICAL_ADDRESS *MipiFrameBufferAddr,
+  IN UINT32 MipiFrameBufferWidth,
+  IN UINT32 MipiFrameBufferHeight,
+  IN EFI_PHYSICAL_ADDRESS HwFrameBufferBase
 )
 {
 
   EFI_STATUS Status             = EFI_SUCCESS;
   EFI_HANDLE hUEFIDisplayHandle = NULL;
 
-  UINT32 MipiFrameBufferWidth  = FixedPcdGet32(PcdMipiFrameBufferWidth);
-  UINT32 MipiFrameBufferHeight = FixedPcdGet32(PcdMipiFrameBufferHeight);
-
-  if(0 == FixedPcdGet32(PcdDefaultGopRotation)){
-    // TODO: get from memory map
-    *MipiFrameBufferAddr = FixedPcdGet32(PcdMipiFrameBufferHardwareBase);
+  if(0 == HwFrameBufferBase){
+    // Hardware framebuffer address is invalid
+    DEBUG((EFI_D_ERROR, "SimpleFbDxe: Invalid hardware framebuffer base\n"));
+    return EFI_INVALID_PARAMETER;
   } else {
     /* Allocate aligned memory for fake framebuffer */
     Status = gBS->AllocatePages(
@@ -954,6 +1006,20 @@ GopFBRotateEntryPoint (
         return EFI_ACCESS_DENIED;
     }
 
+    // Get existing GOP information before uninstalling
+    UINTN FBAddress = 0;
+    UINT32 Vertical = 0;
+    UINT32 Horizontal = 0;
+    Status = GetPrevGopInfo(&FBAddress, &Vertical, &Horizontal);
+    if (EFI_ERROR(Status) || FBAddress == 0) {
+        DEBUG((DEBUG_ERROR, "GetPrevGopInfo failed or invalid FB address read back\n"));
+        Status = EFI_NOT_FOUND;
+        goto ErrorExit;
+    }
+
+    DEBUG((DEBUG_INFO, "GopFBRotateEntryPoint: FBAddress=%p, Vertical=%u, Horizontal=%u\n",
+           (VOID *)FBAddress, Vertical, Horizontal));
+
     Status = ScanGop();
     if (EFI_ERROR(Status)) {
         DEBUG((DEBUG_WARN, "ScanGop returned %r\n", Status));
@@ -971,7 +1037,8 @@ GopFBRotateEntryPoint (
         DEBUG((DEBUG_WARN, "ScanGop after UninstallGop returned %r\n", Status));
     }
 
-    Status = SimpleFbDxeEntry(&FakeFrameBufferAddr);
+    // V and H need to be swapped for rotation
+    Status = SimpleFbDxeEntry(&FakeFrameBufferAddr, Vertical, Horizontal, FBAddress);
     if (EFI_ERROR(Status)) {
         DEBUG((DEBUG_ERROR, "SimpleFbDxeEntry failed: %r\n", Status));
         goto ErrorExit;
@@ -982,9 +1049,12 @@ GopFBRotateEntryPoint (
         DEBUG((DEBUG_WARN, "ScanGop after InstallSimpleGop returned %r\n", Status));
     }
 
+    // V and H need to be swapped for rotation
     Status = StartRotateTask(
         FakeFrameBufferAddr,
-        FixedPcdGet32(PcdMipiFrameBufferHardwareBase)
+        FBAddress,
+        Vertical,
+        Horizontal
     );
     if (EFI_ERROR(Status)) {
         DEBUG((DEBUG_ERROR, "StartRotateTask failed: %r\n", Status));
diff --git a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.inf b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.inf
index bd1f89a6..41280a6d 100644
--- a/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.inf
+++ b/QcomModulePkg/Driver/GopFBRotate/GopFBRotate.inf
@@ -34,9 +34,6 @@
 
 [Pcd]
   gQcomTokenSpaceGuid.PcdDefaultGopRotation
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferWidth
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferHeight
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferHardwareBase
 
 [Protocols]
   gEfiGraphicsOutputProtocolGuid                ## CONSUMES
diff --git a/QcomModulePkg/QcomModulePkg.dec b/QcomModulePkg/QcomModulePkg.dec
index 26d40287..e1fe1f7f 100644
--- a/QcomModulePkg/QcomModulePkg.dec
+++ b/QcomModulePkg/QcomModulePkg.dec
@@ -186,6 +186,4 @@
   # Set default value here for different devices
   # Note: Width and Height are the h/v after rotated.
   gQcomTokenSpaceGuid.PcdDefaultGopRotation|1|UINT32|0x00016001
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferWidth|2560|UINT32|0x00016002
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferHeight|1440|UINT32|0x00016003
-  gQcomTokenSpaceGuid.PcdMipiFrameBufferHardwareBase|0xD5100000|UINT32|0x00016004
+
-- 
2.43.0

